name: Test UDPXY Links

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'  # 每天午夜自动运行一次

jobs:
  test-links:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        file: [iptv, iptvdl]  # 支持并行执行

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download IPTV and IPTVDL lists
        run: |
          curl -s -o iptv.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptv.txt
          curl -s -o iptvdl.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptvdl.txt

      - name: Test links in parallel
        run: |
          input_file=${{ matrix.file }}.txt
          output_file=${{ matrix.file }}-test.txt
          echo "🔍 Testing links from $input_file..." > "$output_file"

          cat "$input_file" | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="$1"
            output_file="$2"
            status="⏳ $url - 测试中..."
            timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null
            CODE=$?
            if [ $CODE -eq 0 ]; then
              status="✅ $url - 可用（10秒内持续下载）"
            elif [ $CODE -eq 124 ]; then
              status="⚠️ $url - 有拦截（10秒内下载结束）"
            else
              status="❌ $url - 无法访问（连接失败）"
            fi
            echo "$status" >> "$output_file"
          ' {} "$output_file"

      - name: Commit and push test results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if [ -f "iptv-test.txt" ]; then
            git add iptv-test.txt
          fi

          if [ -f "iptvdl-test.txt" ]; then
            git add iptvdl-test.txt
          fi

          git commit -m "📡 自动更新 IPTV 测试结果" || echo "Nothing to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

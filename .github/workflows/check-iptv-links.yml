name: Check IPTV Links

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

permissions:
  contents: write  # âœ… å…è®¸å†™å…¥ä»“åº“

jobs:
  check-iptv:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Git config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: ðŸ“¥ Download IPTV lists
        run: |
          curl -sL https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptv.txt -o iptv.txt
          curl -sL https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptvdl.txt -o iptvdl.txt

      - name: ðŸ“¡ Test IPTV links
        run: |
          echo "ðŸ” Testing links from iptv.txt..." > iptv-test.txt
          while read -r url; do
            if [[ ! "$url" =~ ^#.* ]] && [[ -n "$url" ]]; then
              echo "Testing $url..."
              status="â³ $url - æµ‹è¯•ä¸­..."
              if timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null; then
                status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
              else
                CODE=$?
                if [ $CODE -eq 124 ]; then
                  status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
                else
                  status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿žæŽ¥å¤±è´¥ï¼‰"
                fi
              fi
              echo "$status" >> iptv-test.txt
            fi
          done < iptv.txt

      - name: ðŸ“¡ Test IPTVDL links
        run: |
          echo "ðŸ” Testing links from iptvdl.txt..." > iptvdl-test.txt
          while read -r url; do
            if [[ ! "$url" =~ ^#.* ]] && [[ -n "$url" ]]; then
              echo "Testing $url..."
              status="â³ $url - æµ‹è¯•ä¸­..."
              if timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null; then
                status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
              else
                CODE=$?
                if [ $CODE -eq 124 ]; then
                  status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
                else
                  status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿žæŽ¥å¤±è´¥ï¼‰"
                fi
              fi
              echo "$status" >> iptvdl-test.txt
            fi
          done < iptvdl.txt

      - name: ðŸ“¤ Commit and push results
        run: |
          git add --force iptv-test.txt iptvdl-test.txt
          git commit -m "ðŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æžœ $(date -u '+%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git pull --rebase
          git push

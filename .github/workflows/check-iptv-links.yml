name: ðŸ“¡ æ£€æµ‹ IPTV å¯ç”¨æ€§

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© 10:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è¿è¡Œ
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

permissions:
  contents: write        # âœ… å…è®¸ GitHub Actions æŽ¨é€æ›´æ”¹

jobs:
  check-iptv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run IPTV availability check
        run: |
          test_links() {
            input_file="$1"
            output_file="$2"

            echo "ðŸ” Testing links from $input_file..." > "$output_file"

            while read -r url; do
              if [[ -z "$url" || "$url" =~ ^# ]]; then
                continue
              fi

              echo "Testing $url..."
              start_time=$(date +%s)

              curl -s --max-time 15 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null
              curl_code=$?
              end_time=$(date +%s)
              elapsed=$(( end_time - start_time ))

              if [[ $curl_code -eq 0 ]]; then
                if [[ $elapsed -lt 10 ]]; then
                  echo "âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ${elapsed}ç§’å†…ä¸‹è½½ç»“æŸï¼‰" >> "$output_file"
                else
                  echo "âœ… $url - å¯ç”¨ï¼ˆæŒç»­ä¸‹è½½${elapsed}ç§’ï¼‰" >> "$output_file"
                fi
              else
                echo "âŒ $url - æ— æ³•è®¿é—®ï¼ˆcurl é”™è¯¯ç  $curl_codeï¼‰" >> "$output_file"
              fi

            done < "$input_file"
          }

          # æ‰§è¡Œæ£€æµ‹
          test_links "iptv.txt" "iptv-test.txt"
          test_links "iptvdl.txt" "iptvdl-test.txt"

      - name: Commit and push results
        run: |
          git add iptv-test.txt iptvdl-test.txt
          git commit -m "ðŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æžœ $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "âœ… No changes to commit"
          git push

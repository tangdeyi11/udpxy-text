name: Check IPTV Links

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write          # âœ… å…è®¸å†™å…¥ä»£ç ä»“åº“å†…å®¹

jobs:
  check-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test IPTV links
        run: |
          test_url() {
            local url="$1"
            local output_file="$2"

            echo "Testing $url..."
            start_time=$(date +%s)

            curl -s --max-time 15 "$url" -o /dev/null
            curl_code=$?
            end_time=$(date +%s)
            elapsed=$((end_time - start_time))

            if [[ $curl_code -eq 7 ]]; then
              echo "âŒ $url - æ— æ³•è¿æ¥ï¼ˆcurl é”™è¯¯ç  7ï¼‰" >> "$output_file"
            elif [[ $curl_code -eq 0 ]]; then
              if [[ $elapsed -ge 10 ]]; then
                echo "âœ… $url - å¯ç”¨ï¼ˆæŒç»­ä¸‹è½½ ${elapsed} ç§’ï¼‰" >> "$output_file"
              else
                echo "âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆä»…ä¸‹è½½ ${elapsed} ç§’ï¼‰" >> "$output_file"
              fi
            else
              echo "âŒ $url - å¼‚å¸¸é”™è¯¯ï¼ˆcurl é”™è¯¯ç  $curl_codeï¼‰" >> "$output_file"
            fi
          }

          echo "ğŸ” Testing links from iptv.txt..." > iptv-test.txt
          while read -r url; do
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            test_url "$url" "iptv-test.txt"
          done < iptv.txt

          echo "ğŸ” Testing links from iptvdl.txt..." > iptvdl-test.txt
          while read -r url; do
            [[ -z "$url" || "$url" =~ ^# ]] && continue
            test_url "$url" "iptvdl-test.txt"
          done < iptvdl.txt

      - name: Commit and push test results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add iptv-test.txt iptvdl-test.txt

          timestamp=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æœ - $timestamp" || echo "Nothing to commit"

          git pull --rebase
          git push origin main

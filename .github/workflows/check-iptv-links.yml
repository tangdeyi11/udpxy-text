name: è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æœ

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘è¿è¡Œ

permissions:
  contents: write  # âœ… å…è®¸ GitHub Actions å‘ä»£ç ä»“åº“å†™å…¥å†…å®¹

jobs:
  update-iptv:
    runs-on: ubuntu-latest

    steps:
      # Checkout ä»“åº“
      - name: Checkout code
        uses: actions/checkout@v2

      # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Set Git identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"

      # æ‹‰å–è¿œç¨‹åˆ†æ”¯çš„æ›´æ–°å¹¶è§£å†³å¯èƒ½çš„å†²çª
      - name: Pull the latest changes from remote
        run: |
          git pull origin main --rebase

      # æµ‹è¯• IPTV é“¾æ¥å¹¶ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      - name: Test IPTV links
        run: |
          echo "ğŸ” Testing links from iptv.txt..." > iptv-test.txt
          cat iptv.txt | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="{}"
            status="â³ $url - æµ‹è¯•ä¸­..."
            timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null
            CODE=$?
            if [ $CODE -eq 0 ]; then
              status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
            elif [ $CODE -eq 124 ]; then
              status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
            else
              status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿æ¥å¤±è´¥ï¼‰"
            fi
            echo "$status" >> iptv-test.txt
          '

          echo "ğŸ” Testing links from iptvdl.txt..." > iptvdl-test.txt
          cat iptvdl.txt | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="{}"
            status="â³ $url - æµ‹è¯•ä¸­..."
            timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null
            CODE=$?
            if [ $CODE -eq 0 ]; then
              status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
            elif [ $CODE -eq 124 ]; then
              status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
            else
              status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿æ¥å¤±è´¥ï¼‰"
            fi
            echo "$status" >> iptvdl-test.txt
          '

      # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶å¹¶æäº¤æ›´æ”¹
      - name: Commit and push results
        run: |
          git add --force iptv-test.txt iptvdl-test.txt
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S")
          git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æœ on ${timestamp}" || echo "No changes to commit"
          git push origin main

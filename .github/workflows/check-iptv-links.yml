name: Test UDPXY Links

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åˆå¤œè‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  test-links:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: [iptv, iptvdl]  # å¤„ç†ä¸¤ä¸ªæ–‡ä»¶ï¼šiptv.txt å’Œ iptvdl.txt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download URL list files
        run: |
          curl -s -o iptv.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptv.txt
          curl -s -o iptvdl.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptvdl.txt

      - name: Test ${ matrix.file } links (å¹¶å‘å¤„ç†)
        run: |
          input_file=${{ matrix.file }}.txt
          output_file=${{ matrix.file }}-test.txt
          echo "ðŸ” Testing links from $input_file..." > $output_file

          cat $input_file | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="{}"
            status="â³ $url - æµ‹è¯•ä¸­..."
            timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null
            CODE=$?
            if [ $CODE -eq 0 ]; then
              status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
            elif [ $CODE -eq 124 ]; then
              status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
            else
              status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿žæŽ¥å¤±è´¥ï¼‰"
            fi
            echo "$status" >> $output_file
          '

      - name: Commit and push test results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add iptv-test.txt iptvdl-test.txt
          git commit -m "ðŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æžœ" || echo "Nothing to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

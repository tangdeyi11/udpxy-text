name: Check IPTV Links

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # âœ… å…è®¸æäº¤ç»“æžœæ–‡ä»¶

jobs:
  test-iptv:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Test IPTV links and generate results
        run: |
          test_links() {
            input_file="$1"
            output_file="$2"

            echo "ðŸ” Testing links from $input_file..." > "$output_file"

            while read -r url; do
              if [[ -z "$url" || "$url" =~ ^# ]]; then
                continue
              fi

              echo "Testing $url..."
              start_time=$(date +%s)

              # æå–ä¸»æœºå’Œç«¯å£
              host=$(echo $url | cut -d'/' -f3)
              port=$(echo $url | cut -d':' -f2)

              # ä½¿ç”¨ nc æ¥æµ‹è¯• TCP è¿žæŽ¥
              timeout 10 nc -z -v "$host" "$port"
              nc_code=$?

              end_time=$(date +%s)
              elapsed=$(( end_time - start_time ))

              if [[ $nc_code -eq 0 ]]; then
                if [[ $elapsed -ge 10 ]]; then
                  echo "âœ… $url - å¯ç”¨ï¼ˆæŒç»­è¿žæŽ¥ ${elapsed} ç§’ï¼‰" >> "$output_file"
                else
                  echo "âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ${elapsed} ç§’å†…è¿žæŽ¥ç»“æŸï¼‰" >> "$output_file"
                fi
              else
                echo "âŒ $url - æ— æ³•è¿žæŽ¥ï¼ˆnc é”™è¯¯ç  $nc_codeï¼‰" >> "$output_file"
              fi
            done < "$input_file"
          }

          test_links "iptv.txt" "iptv-test.txt"
          test_links "iptvdl.txt" "iptvdl-test.txt"

      - name: ðŸ“¤ Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add --force iptv-test.txt iptvdl-test.txt
          git commit -m "ðŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æžœ $(date -u '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          git pull --rebase
          git push

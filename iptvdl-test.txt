name: Test IPTV Links

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸å¯¹ä»“åº“å†…å®¹è¿›è¡Œå†™æ“ä½œ

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Download links from GitHub
        run: |
          # ä¸‹è½½ IPTV å’Œ IPTVDL é“¾æ¥åˆ°æ ¹ç›®å½•
          curl -L -o iptv.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptv.txt
          curl -L -o iptvdl.txt https://raw.githubusercontent.com/tangdeyi11/udpxy-text/main/iptvdl.txt

      - name: Initialize output files
        run: |
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–æ–‡ä»¶
          touch iptv-test.txt iptvdl-test.txt

      # ä¸²è¡Œæ‰§è¡Œ IPTV é“¾æ¥æµ‹è¯•
      - name: Test IPTV links
        run: |
          input_file="iptv.txt"
          output_file="iptv-test.txt"
          echo "ğŸ” Testing links from $input_file..." > "$output_file"
          
          export OUTPUT_FILE="$output_file"  # ä¼ é€’ä¸ºç¯å¢ƒå˜é‡ä¾› subshell ä½¿ç”¨

          cat "$input_file" | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="{}"
            status="â³ $url - æµ‹è¯•ä¸­..."
            if timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null; then
              status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
            else
              code=$?
              if [ $code -eq 124 ]; then
                status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
              else
                status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿æ¥å¤±è´¥ï¼‰"
              fi
            fi
            echo "$status" >> "$OUTPUT_FILE"
          '

      # ä¸²è¡Œæ‰§è¡Œ IPTVDL é“¾æ¥æµ‹è¯•
      - name: Test IPTVDL links
        run: |
          input_file="iptvdl.txt"
          output_file="iptvdl-test.txt"
          echo "ğŸ” Testing links from $input_file..." > "$output_file"
          
          export OUTPUT_FILE="$output_file"  # ä¼ é€’ä¸ºç¯å¢ƒå˜é‡ä¾› subshell ä½¿ç”¨

          cat "$input_file" | grep -v '^#' | grep -v '^$' | xargs -I {} -P 10 bash -c '
            url="{}"
            status="â³ $url - æµ‹è¯•ä¸­..."
            if timeout 10s curl -s --max-time 12 --speed-time 5 --speed-limit 1024 "$url" -o /dev/null; then
              status="âœ… $url - å¯ç”¨ï¼ˆ10ç§’å†…æŒç»­ä¸‹è½½ï¼‰"
            else
              code=$?
              if [ $code -eq 124 ]; then
                status="âš ï¸ $url - æœ‰æ‹¦æˆªï¼ˆ10ç§’å†…ä¸‹è½½ç»“æŸï¼‰"
              else
                status="âŒ $url - æ— æ³•è®¿é—®ï¼ˆè¿æ¥å¤±è´¥ï¼‰"
              fi
            fi
            echo "$status" >> "$OUTPUT_FILE"
          '

      # æ‹‰å–è¿œç¨‹ä»“åº“çš„æ›´æ”¹ï¼Œé¿å…æ¨é€å†²çª
      - name: Pull remote changes and rebase
        run: |
          git fetch origin
          git pull --rebase origin main

      # æäº¤å¹¶æ¨é€æµ‹è¯•ç»“æœæ–‡ä»¶åˆ° GitHub ä»“åº“
      - name: Commit and push results for IPTV
        run: |
          git add --force iptv-test.txt
          git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–° IPTV æµ‹è¯•ç»“æœ" || echo "Nothing to commit"
          git push origin main  # æ¨é€åˆ°è¿œç¨‹ä»“åº“

      - name: Commit and push results for IPTVDL
        run: |
          git add --force iptvdl-test.txt
          git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–° IPTVDL æµ‹è¯•ç»“æœ" || echo "Nothing to commit"
          git push origin main  # æ¨é€åˆ°è¿œç¨‹ä»“åº“
